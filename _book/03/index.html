
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Chapter 3: Processes Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="../04/" />
    
    
    <link rel="prev" href="../02/" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    README
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../01/">
            
                <a href="../01/">
            
                    
                    Chapter 1 HelloWorld
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../02/">
            
                <a href="../02/">
            
                    
                    Chapter 2: Objects and Handles
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.4" data-path="./">
            
                <a href="./">
            
                    
                    Chapter 3: Processes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../04/">
            
                <a href="../04/">
            
                    
                    Chapter 4: Jobs
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Chapter 3: Processes</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="chapter-4-processes">Chapter 4: Processes</h1>
<h2 id="process-basics">Process basics</h2>
<p>&#x5728;&#x57FA;&#x672C;&#x7684;process&#x7684;&#x57FA;&#x7840;&#x4E4B;&#x4E0A;&#x53C8;&#x53D1;&#x5C55;&#x51FA;&#x5F88;&#x591A;process&#x7C7B;&#x578B;</p>
<ul>
<li>Protected processes : &#x521B;&#x5EFA;&#x4E4B;&#x521D;&#x662F;&#x4E3A;&#x4E86;&#x4FDD;&#x62A4;&#x5177;&#x6709;&#x6570;&#x5B57;&#x4EA7;&#x6743;&#x7684;&#x8FDB;&#x7A0B;&#x514D;&#x53D7;&#x522B;&#x7684;&#x8FDB;&#x7A0B;&#x7684;&#x8BBF;&#x95EE;&#xFF0C; &#x7BA1;&#x7406;&#x5458;&#x8FDB;&#x7A0B;&#x4E5F;&#x4E0D;&#x80FD;&#x8BBF;&#x95EE;&#x88AB;&#x4FDD;&#x62A4;&#x8FDB;&#x7A0B;&#x7684;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#x3002;</li>
<li><p>UWP processes : host the Windows Runtime, and typically are published to the Microsoft Store</p>
<ul>
<li>A UWP process executes inside an AppContainer - a sandbox of sorts that limits the operations this
process can carry out.</li>
</ul>
</li>
<li><p>Protected Processes Light &#xFF1A;PPL&#xFF0C;admin-level processes&#x90FD;&#x4E0D;&#x80FD;&#x8BBF;&#x95EE;&#x5176;&#x5185;&#x5B58;&#x3002;&#x53EF;&#x4EE5;&#x4F7F;&#x4E00;&#x4E2A;&#x7B2C;&#x4E09;&#x65B9;&#x670D;&#x52A1;&#x4EE5;PPL&#x8FDB;&#x7A0B;&#x8FD0;&#x884C;</p>
</li>
<li><p>Minimal Processes : no executable file mapped into the process address space, and no DLLs , The process address space is truly empty</p>
</li>
<li><p>Pico Processes: &#x6BD4;minimal process&#x591A;&#x4E86;&#x4E00;&#x4E2A;pico provider, &#xFF08;kernel driver) &#x53EF;&#x4EE5;&#x62E6;&#x622A;Linux&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x8F6C;&#x5316;&#x4E3A;&#x7B49;&#x4EF7;&#x7684;Windows&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#xFF0C;wsl&#x5B9E;&#x73B0;&#x7684;&#x57FA;&#x7840;&#x3002;</p>
</li>
</ul>
<blockquote>
<p>minimal and Pico processes can only be created by the kernel.</p>
</blockquote>
<p>PID : &#x503C;&#x90FD;&#x662F;4&#x7684;&#x500D;&#x6570;&#xFF0C;&#x6700;&#x5C0F;&#x7684;PID&#x662F;4</p>
<blockquote>
<p> handles also start with 4 and are multiples of 4</p>
</blockquote>
<p>Status : Running, Suspended&#xFF08;&#x6682;&#x505C;&#xFF09; and Not Responding.</p>
<p>GUI process Not Responding &#xFF1A;&#x4E00;&#x4E2A;GUI Process&#x81F3;&#x5C11;&#x6709;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;&#x6765;&#x5904;&#x7406;&#x5B83;&#x7684;&#x4E0E;&#x7528;&#x6237;&#x7684;&#x4EA4;&#x4E92;&#xFF0C;&#x8FD9;&#x4E2A;thread&#x4F1A;&#x6709;&#x4E00;&#x4E2A;&#x6D88;&#x606F;&#x961F;&#x5217;message queue(&#x53EA;&#x8981;&#x8C03;&#x7528;&#x4EFB;&#x4F55;UI&#x3001;GDI&#x51FD;&#x6570;&#x90FD;&#x4F1A;&#x6709;&#x6D88;&#x606F;&#x961F;&#x5217;)&#xFF0C;thread&#x901A;&#x8FC7;GetMessage&#x548C;PeekMessage&#x83B7;&#x53D6;&#x548C;&#x9001;&#x51FA;&#x6D88;&#x606F;&#x961F;&#x5217;&#xFF08;&#x4E5F;&#x53EF;&#x80FD;&#x662F;&#x522B;&#x7684;API&#xFF09;&#xFF0C;&#x8D85;&#x8FC7;5&#x79D2;&#x6CA1;&#x6709;&#x4EFB;&#x4F55;&#x7C7B;&#x4F3C;&#x51FD;&#x6570;&#x8C03;&#x7528;&#xFF0C;&#x7CFB;&#x7EDF;&#x5C31;&#x4F1A;&#x628A;&#x8FD9;&#x4E2A;&#x7EBF;&#x7A0B;&#x5224;&#x5B9A;&#x4E3A;Not Responding&#x72B6;&#x6001;</p>
<p>UWP processes &#x5728;move into the background&#x4F1A;&#x88AB;&#x6682;&#x505C;</p>
<p>Non-UWP processes that have no GUI are always shown with a Running status&#xFF0C;&#x9664;&#x975E;&#x8FD9;&#x4E2A;&#x8FDB;&#x7A0B;&#x6240;&#x6709;&#x7684;&#x7EBF;&#x7A0B;&#x90FD;&#x88AB;&#x6682;&#x505C;</p>
<p>&#x53EF;&#x4EE5;&#x4F7F;&#x7528;NtSuspendProcess&#x548C;NtResumeProcessg&#x6682;&#x505C;/&#x91CD;&#x65B0;&#x8FD0;&#x884C;&#x4E00;&#x4E2A;thread</p>
<p>&#x8FDB;&#x7A0B;&#x7684;session id &#xFF1A;  Session 0 is used for system &#xFF0C; session 1 and higher are used for interactive logins</p>
<h2 id="process-creation">Process Creation</h2>
<h3 id="&#x5927;&#x81F4;flow">&#x5927;&#x81F4;flow</h3>
<p><img src="README/image-20210818232503530.png" alt="image-20210818232503530"></p>
<ul>
<li>&#x901A;&#x77E5;CSRSS.exe &#x6709;&#x65B0;&#x7684;&#x8FDB;&#x7A0B;&#x3001;&#x7EBF;&#x7A0B;&#x7684;&#x521B;&#x5EFA;&#xFF0C;Csrss  is a helper to the kernel for managing some aspects of Windows subsystem processes</li>
</ul>
<p>&#x65B0;&#x8FDB;&#x7A0B;&#x521B;&#x5EFA;&#x5B8C;&#x6BD5;</p>
<hr>
<ul>
<li><p>&#x65B0;&#x8FDB;&#x7A0B;&#x521D;&#x59CB;&#x5316;&#xFF1A;</p>
<ul>
<li>NtDll &#x4E3A;&#x65B0;&#x8FDB;&#x7A0B;&#x521B;&#x5EFA;  Process Environment Block &#xFF08;PEB&#xFF09; &#xFF08;user-mode management object for the process&#xFF09;</li>
<li>&#x548C;TEB Thread Environment Block &#xFF0C; user mode management object for the thread<ul>
<li>PEB TEB&#x90FD;&#x5728;winternl.h</li>
</ul>
</li>
</ul>
<blockquote>
<p>&#x4F7F;&#x7528;NtCurrentTeb() &#x8BBF;&#x95EE;&#x5F53;&#x524D;&#x7EBF;&#x7A0B;TEB&#xFF0C;&#x901A;&#x8FC7;NtCurrentTeb()-&gt;ProcessEnvironmentBlock&#x8BBF;&#x95EE;&#x5F53;&#x524D;&#x8FDB;&#x7A0B;PEB</p>
</blockquote>
<ul>
<li><p>process heap&#x521B;&#x5EFA;</p>
</li>
<li><p>&#x521B;&#x5EFA;&#x7EBF;&#x7A0B;&#x6C60;</p>
</li>
<li><p>&#x52A0;&#x8F7D;DLLs (DLL hijacking) ,  kernel32.dll, user32.dll, gdi32.dll , advapi32.dll</p>
<ul>
<li>&#x4F7F;&#x7528;dumpbin&#x53EF;&#x67E5;&#x770B;&#x52A0;&#x8F7D;&#x7684;dll&#x548C;&#x51FD;&#x6570;</li>
<li>C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\VC\Tools\MSVC\14.29.30037\bin\Hostx64\x86\dumpbin.exe</li>
<li>&#x4F7F;&#x7528;PE Explorer&#x4E5F;&#x53EF;&#x4EE5;&#x3002;</li>
<li>API Sets&#x7684;&#x6982;&#x5FF5;&#xFF1A;&#x53EA;&#x63D0;&#x4F9B;&#x63A5;&#x53E3;&#xFF0C;&#x5177;&#x4F53;&#x7684;&#x5B9E;&#x73B0;&#x53EF;&#x4EE5;&#x5728;&#x522B;&#x7684;&#x5730;&#x65B9;&#x3002;&#x901A;&#x8FC7;PEB&#x7ED3;&#x6784;&#x4F53;&#x53EF;&#x4EE5;&#x67E5;&#x770B;&#x5230;&#x548C;APISets&#x5BF9;&#x8C61;&#x7684;&#x5B9E;&#x73B0;&#x3002;</li>
<li><p>dll&#x7684;&#x52A0;&#x8F7D;&#x987A;&#x5E8F;</p>
<ol>
<li>KnownDLLs<ul>
<li>HKEY_LOCAL_MA-CHINE\SYSTEM\CurrentControlSet\Control\Session Manager\KnownDLLs</li>
</ul>
</li>
<li>The directory of the executable</li>
<li>The current directory of the process</li>
<li>The System directory returned by GetSystemDirectory &#xFF0C; c:\windows\system32</li>
<li>The Windows directory returned by GetWindowsDirectory &#xFF0C; c:\Windows</li>
<li>The directories listed in the PATH environment variable</li>
</ol>
</li>
<li><p>&#x8C03;&#x7528;dll&#x7684;dllmain&#x51FD;&#x6570;&#x8FDB;&#x884C;&#x521D;&#x59CB;&#x5316;</p>
</li>
</ul>
</li>
<li><p>&#x6267;&#x884C;exe&#x7684;&#x5165;&#x53E3;&#x51FD;&#x6570; &#xFF08;entry point&#xFF09;</p>
<ul>
<li>&#x521D;&#x59CB;&#x5316;C/C++ runtime&#x51FD;&#x6570;&#xFF0C;malloc,new,fopen</li>
<li>...</li>
<li>&#x5F53;&#x6240;&#x6709;&#x8FD9;&#x4E9B;&#x521D;&#x59CB;&#x5316;&#x64CD;&#x4F5C;&#x5B8C;&#x6210;&#x540E;&#xFF0C; C/C + +&#x542F;&#x52A8;&#x51FD;&#x6570;&#x5C31;&#x8C03;&#x7528;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x8FDB;&#x5165;&#x70B9;&#x51FD;&#x6570;</li>
<li>&#x8FD0;&#x884C;main&#x51FD;&#x6570;main/wmain/Winmain/wWinmain</li>
</ul>
<p><img src="README/image-20210819000647796.png" alt="image-20210819000647796"></p>
<p>&#x8FD9;&#x4E2A;&#x53EF;&#x4EE5;&#x5728;&#x9879;&#x76EE;&#x5C5E;&#x6027;&#x8BBE;&#x7F6E;</p>
<p><img src="README/image-20210819001047730.png" alt="image-20210819001047730"></p>
<p>GUI/CUI Application&#x7684;&#x533A;&#x522B;&#x5728;&#x70B9;&#x51FD;&#x6570;&#x7684;&#x4E0D;&#x540C;&#xFF0C;&#x542F;&#x52A8;&#x51FD;&#x6570;&#x7684;&#x4E0D;&#x540C;&#x3002;</p>
</li>
</ul>
</li>
</ul>
<h3 id="main-functions">main Functions</h3>
<pre><code class="lang-c++"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* argv[])</span></span>; <span class="hljs-comment">// const is optional</span>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">wmain</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">const</span> wchar_t* argv[])</span></span>; <span class="hljs-comment">// const is optional</span>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">WinMain</span><span class="hljs-params">(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR commandLine, <span class="hljs-keyword">int</span> showCmd)</span></span>;
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">wWinMain</span><span class="hljs-params">(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPWSTR commandLine, <span class="hljs-keyword">int</span> showCmd)</span></span>;
</code></pre>
<p>main&#x548C;wmain&#x662F;CUI&#x7A0B;&#x5E8F;&#x7684;&#x5165;&#x53E3;&#x70B9;&#x51FD;&#x6570;&#x3002;</p>
<p>winMain&#x548C;wWinMain&#x662F;GUI&#x7A0B;&#x5E8F;&#x7684;&#x5165;&#x53E3;&#x70B9;&#x51FD;&#x6570;&#x3002;</p>
<p>&#x53C2;&#x6570;&#x8BF4;&#x660E;&#xFF1A;</p>
<ul>
<li>argc : &#x53C2;&#x6570;&#x4E2A;&#x6570; &gt;= 1</li>
<li>argv : &#x53C2;&#x6570;&#x6570;&#x7EC4;&#xFF0C; argv[0] &#x4E3A; &#x53EF;&#x6267;&#x884C;&#x6587;&#x4EF6;&#x7684;full path</li>
<li>hInstance :  it&#x2019;s the address to which the executable is mapped , &#x8FD9;&#x4E2A;&#x503C;&#x7531;&#x7F16;&#x8BD1;&#x5668;&#x51B3;&#x5B9A;<ul>
<li>HINSTANCE type == HMODULE type(&#x6A21;&#x5757;&#x53E5;&#x67C4;)</li>
</ul>
</li>
</ul>
<p><img src="README/image-20210819223633157.png" alt="image-20210819223633157"></p>
<ul>
<li><p>hPrevInstance :  represent the HINSTANCE of a previous instance of the same executable &#xFF0C;&#x901A;&#x5E38;&#x503C;&#x4E3A;NULL</p>
</li>
<li><p>commandLine ; cmdline &#xFF0C;&#x4F46;&#x662F;&#x4E0D;&#x5305;&#x62EC;&#x53EF;&#x6267;&#x884C;&#x6587;&#x4EF6;&#x8DEF;&#x5F84;&#xFF0C;string&#x7C7B;&#x578B;&#xFF0C;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x4E0B;&#x9762;&#x7684;api&#x8F6C;&#x6362;&#x4E3A;&#x6570;&#x7EC4;&#x3002;</p>
<pre><code class="lang-c++"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;ShellApi.h&gt;</span></span>
<span class="hljs-function">LPWSTR* <span class="hljs-title">CommandLineToArgvW</span><span class="hljs-params">(_In_ LPCWSTR lpCmdLine, _Out_ <span class="hljs-keyword">int</span>* pNumArgs)</span></span>;
<span class="hljs-comment">// &#x8FD4;&#x56DE;&#x4E00;&#x4E2A;&#x6307;&#x9488;&#xFF0C;&#x6307;&#x5411;&#x4E00;&#x4E2A;p-string&#x6570;&#x7EC4;</span>
<span class="hljs-comment">// pNumArgs : &#x8FD4;&#x56DE;&#x7684;&#x53C2;&#x6570;&#x4E2A;&#x6570;</span>

<span class="hljs-comment">// demo    int count;</span>
PWSTR* args = CommandLineToArgvW(lpCmdLine, &amp;count);
WCHAR text[<span class="hljs-number">1024</span>] = { <span class="hljs-number">0</span> };
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; count; i++) {
    ::wcscat_s(text, <span class="hljs-number">1024</span>, args[i]);
    ::wcscat_s(text, <span class="hljs-number">1024</span>, <span class="hljs-string">L&quot;\n&quot;</span>);
}
::LocalFree(args); <span class="hljs-comment">// &#x4F7F;&#x7528;LocalFree&#x6765;&#x91CA;&#x653E;&#x5185;&#x5B58;</span>
::MessageBox(<span class="hljs-literal">nullptr</span>, text, <span class="hljs-string">L&quot;Command Line Arguments&quot;</span>, MB_OK);
</code></pre>
<ul>
<li>&#x8FD9;&#x4E2A;api&#x7684;&#x7279;&#x6027;<ul>
<li>&#x5982;&#x679C;&#x4F20;&#x7684;&#x53C2;&#x6570;&#x662F;&#x4E00;&#x4E2A;empty string&#xFF0C;&#x8FD4;&#x56DE;&#x7684;&#x5C31;&#x662F;full executable path</li>
<li>&#x5426;&#x5219;&#x8FD4;&#x56DE;&#x7684;&#x5C31;&#x662F;&#x4E00;&#x4E2A;&#x6570;&#x7EC4;&#xFF0C;&#x4E0D;&#x5305;&#x62EC;full executable path</li>
</ul>
</li>
<li>GetCommandLine &#x83B7;&#x5F97;cmdline (string) , &#x53EF;&#x4EE5;&#x4F20;&#x9012;&#x7ED9;CommandLineToArgvw</li>
</ul>
</li>
<li><p>showCmd &#xFF1A;&#x5982;&#x4F55;&#x5C55;&#x793A;&#x8FD9;&#x4E2A;application&#x7684;Window</p>
</li>
</ul>
<h3 id="process-environment-variables">Process Environment Variables</h3>
<p>The names and values are stored in the Registry (like most system data in Windows) --&gt; &#x73AF;&#x5883;&#x53D8;&#x91CF;&#x7684;&#x503C;&#x662F;&#x50A8;&#x5B58;&#x5728;&#x6CE8;&#x518C;&#x8868;&#x91CC;&#x7684;&#xFF0C;&#x77E5;&#x8BC6;&#x76F2;&#x533A;</p>
<pre><code>user&#x7684;&#x73AF;&#x5883;&#x53D8;&#x91CF;&#xFF1A;HKEY_CURRENT_USER\Environment
system&#x7684;&#x73AF;&#x5883;&#x53D8;&#x91CF; &#xFF1A;HKEY_LOCAL_MACHINE\System\Current ControlSet\Control\SessionManager\Environment
</code></pre><p>A process receives environment variables from its parent process &#xFF08;copy )</p>
<pre><code class="lang-c"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span>* argv[], <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* env[])</span></span>; <span class="hljs-comment">// const is optional</span>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">wmain</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, wchar_t* argv[], <span class="hljs-keyword">const</span> wchar_t* env[])</span></span>; <span class="hljs-comment">// const is optional</span>
</code></pre>
<p>&#x83B7;&#x5F97;&#x73AF;&#x5883;&#x53D8;&#x91CF;&#x7684;key&#x548C;value</p>
<pre><code class="lang-c++"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* argv[], <span class="hljs-keyword">char</span>* env[])</span> </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; ; i++) {
        <span class="hljs-keyword">if</span> (env[i] == <span class="hljs-literal">nullptr</span>)
            <span class="hljs-keyword">break</span>;
        <span class="hljs-comment">// printf(&quot;[~]%s&quot;, env[i]);</span>
        <span class="hljs-keyword">auto</span> equals = <span class="hljs-built_in">strchr</span>(env[i], <span class="hljs-string">&apos;=&apos;</span>); <span class="hljs-comment">// &#x8FD4;&#x56DE;&#x5339;&#x914D;&#x5230;&#x7684;&#x5730;&#x5740;</span>
        <span class="hljs-comment">// equals&#x662F;&#x4E00;&#x4E2A;&#x5730;&#x5740;</span>
        *equals = <span class="hljs-string">&apos;\0&apos;</span>; <span class="hljs-comment">// &#x628A; = &#x6362;&#x6210; \0</span>
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s: %s\n&quot;</span>, env[i], equals + <span class="hljs-number">1</span>);
        <span class="hljs-comment">// printf(&quot;[!]%s&quot;, env[i]);</span>
        *equals = <span class="hljs-string">&apos;=&apos;</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<ul>
<li>&#x4E0A;&#x9762;env&#x662F;&#x4E00;&#x4E2A;string&#x6570;&#x7EC4;&#xFF0C;&#x6BCF;&#x4E00;&#x4E2A;&#x5143;&#x7D20;&#x7684;&#x683C;&#x5F0F;&#x662F;xxx=xxx</li>
</ul>
<pre><code class="lang-c++">PWSTR env = ::GetEnvironmentStrings(); <span class="hljs-comment">// GetEnvironmentStrings</span>
WCHAR text[<span class="hljs-number">8192</span>] = { <span class="hljs-number">0</span> };
<span class="hljs-keyword">auto</span> p = env;
<span class="hljs-keyword">while</span> (*p) {
    <span class="hljs-keyword">auto</span> equals = wcschr(p, L<span class="hljs-string">&apos;=&apos;</span>);
    <span class="hljs-keyword">if</span> (equals != p) {
        <span class="hljs-comment">// eliminate empty names/values</span>
        wcsncat_s(text, p, equals - p);
        wcscat_s(text, <span class="hljs-string">L&quot;: &quot;</span>);
        wcscat_s(text, equals + <span class="hljs-number">1</span>);
        wcscat_s(text, <span class="hljs-string">L&quot;\n&quot;</span>);
    }
    p += wcslen(p) + <span class="hljs-number">1</span>;
}
::FreeEnvironmentStrings(env); <span class="hljs-comment">// &#x91CA;&#x653E;&#x5185;&#x5B58;</span>
</code></pre>
<p>&#x83B7;&#x5F97;&#x3001;&#x6539;&#x53D8;&#x5355;&#x4E2A;&#x73AF;&#x5883;&#x53D8;&#x91CF;&#x503C;</p>
<pre><code class="lang-c++"><span class="hljs-function">BOOL <span class="hljs-title">SetEnvironmentVariable</span><span class="hljs-params">(
    _In_ LPCTSTR lpName,
    _In_opt_ LPCTSTR lpValue)</span></span>;
<span class="hljs-function">DWORD <span class="hljs-title">GetEnvironmentVariable</span><span class="hljs-params">(
    _In_opt_ LPCTSTR lpName,
    _Out_ LPTSTR lpBuffer,
    _In_ DWORD nSize)</span></span>;
</code></pre>
<p>GetEnvironmentVariable&#x7ECF;&#x5178;&#x7528;&#x6CD5;</p>
<pre><code class="lang-c++"><span class="hljs-built_in">std</span>::<span class="hljs-function">wstring <span class="hljs-title">ReadEnvironmentVariable</span><span class="hljs-params">(PCWSTR name)</span> </span>{
    DWORD count = ::GetEnvironmentVariable(name, <span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>); <span class="hljs-comment">// &#x5148;&#x83B7;&#x53D6;&#x5B57;&#x7B26;&#x4E32;&#x7684;&#x5927;&#x5C0F;</span>
    <span class="hljs-keyword">if</span> (count &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-built_in">std</span>::wstring value; <span class="hljs-comment">// &#x7533;&#x8BF7;&#x4E00;&#x4E2A;buffer</span>
        value.resize(count);
        ::GetEnvironmentVariable(name, <span class="hljs-keyword">const_cast</span>&lt;PWSTR&gt;(value.data()), count);
        <span class="hljs-comment">// &#x83B7;&#x5F97;value</span>
        <span class="hljs-keyword">return</span> value;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-string">L&quot;&quot;</span>;
}
</code></pre>
<p>&#x628A;%windir%\explorer.exe&#x8F6C;&#x6362;&#x4E3A; c:\windows\explorer.exe</p>
<pre><code class="lang-c++"><span class="hljs-function">DWORD <span class="hljs-title">ExpandEnvironmentStrings</span><span class="hljs-params">(
    _In_ LPCTSTR lpSrc,
    _Out_opt_ LPTSTR lpDst,
    _In_ DWORD nSize)</span></span>;

WCHAR path[MAX_PATH];
::ExpandEnvironmentStrings(<span class="hljs-string">L&quot;%windir%\\explorer.exe&quot;</span>, path, MAX_PATH); <span class="hljs-comment">// MAX_PATH&#x662F;file PATH&#x7684;&#x503C;</span>
<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%ws\n&quot;</span>, path); <span class="hljs-comment">// c:\windows\explorer.exe</span>
</code></pre>
<h3 id="creating-processes">Creating Processes</h3>
<p>CreateProcess&#x51FD;&#x6570;&#xFF1A;</p>
<pre><code class="lang-c++"><span class="hljs-function">BOOL <span class="hljs-title">CreateProcess</span><span class="hljs-params">(
    _In_opt_ PCTSTR pApplicationName, <span class="hljs-comment">// executable path</span>
    _Inout_opt_ PTSTR pCommandLine,   <span class="hljs-comment">// command-line arguments</span>
    _In_opt_ PSECURITY_ATTRIBUTES pProcessAttributes, 
    _In_opt_ PSECURITY_ATTRIBUTES pThreadAttributes,
    _In_ BOOL bInheritHandles, 
    _In_ DWORD dwCreationFlags,
    _In_opt_ PVOID pEnvironment, 
    _In_opt_ PCTSTR pCurrentDirectory,
    _In_ PSTARTUPINFO pStartupInfo,
    _Out_ PPROCESS_INFORMATION lpProcessInformation)</span></span>;
</code></pre>
<p>&#x8FD4;&#x56DE;&#x503C;&#x4E3A;BOOL&#x7C7B;&#x578B;&#xFF0C;&#x6210;&#x529F;&#x8FD4;&#x56DE;True&#x3002;means that from the kernel&#x2019;s perspective the process and the initial thread have been created successfully&#x3002;&#xFF08;&#x521D;&#x59CB;&#x5316;&#x8FC7;&#x7A0B;&#x4E5F;&#x53EF;&#x80FD;&#x5931;&#x8D25;&#xFF09;</p>
<p>&#x8FD4;&#x56DE;&#x7684;&#x7EBF;&#x7A0B;&#x4FE1;&#x606F;&#xFF1A;PPROCESS_INFORMATION&#xFF1A;</p>
<pre><code class="lang-c++"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> _PROCESS_INFORMATION { 
  HANDLE hProcess; 
  HANDLE hThread; 
  DWORD dwProcessId; <span class="hljs-comment">// pid</span>
  DWORD dwThreadId;  <span class="hljs-comment">// tid</span>
} PROCESS_INFORMATION, *PPROCESS_INFORMATION;
</code></pre>
<p>&#x5BF9;&#x4E8E;&#x65B0;&#x521B;&#x5EFA;&#x7684;&#x8FDB;&#x7A0B;&#x548C;&#x7EBF;&#x7A0B;&#xFF1A;with all possible permissions unless the new process is protected&#x3002;&#x62E5;&#x6709;user&#x7684;&#x6240;&#x6709;&#x6743;&#x9650;&#x3002;&#x9664;&#x975E;&#x88AB;&#x4FDD;&#x62A4;&#x3002;</p>
<p>&#x5BF9;&#x4E8E;pApplicationName&#x548C;pCommandLine&#xFF0C;&#x6709;&#x4E24;&#x79CD;&#x5199;&#x6CD5;&#xFF1A;</p>
<ol>
<li>pApplicationName&#x4E3A;NULL&#xFF0C;&#x4ECE;pCommandLine&#x4E2D;&#x52A0;&#x8F7D;&#x7A0B;&#x5E8F;&#x3002;&#x53EF;&#x4EE5;&#x662F;&#x76F8;&#x5BF9;&#x8DEF;&#x5F84;&#xFF0C;&#x52A0;&#x8F7D;&#x987A;&#x5E8F;&#xFF1A;</li>
</ol>
<pre><code>1. The directory of the caller&#x2019;s executable
2. The current directory of the process (discussed later in this section)
3. The System directory returned by GetSystemDirectory
4. The Windows directory returned by GetWindowsDirectory
5. The directories listed in the PATH environment variable
</code></pre><ol>
<li>pApplicationName&#x4E0D;&#x4E3A;NULL&#xFF0C;&#x5FC5;&#x987B;&#x4E3A;full path&#x3002;</li>
</ol>
<p>! cmdline&#x7684;&#x7C7B;&#x578B;&#x4E3A;PTSTR&#xFF0C;&#x4E0D;&#x80FD;&#x586B;static String&#x8FDB;&#x53BB;&#x3002;</p>
<pre><code class="lang-c++">CreateProcess(<span class="hljs-literal">nullptr</span>, <span class="hljs-string">L&quot;Notepad&quot;</span>, ...); <span class="hljs-comment">// access violation</span>

WCHAR name[] = <span class="hljs-string">L&quot;Notepad&quot;</span>; 
CreateProcess(<span class="hljs-literal">nullptr</span>, name, ...); <span class="hljs-comment">// yes</span>
</code></pre>
<p>pProcessAttributes and pThreadAttributes&#xFF1A;&#x6307;&#x5411;&#x4E00;&#x4E2A;SECURITY_ATTRIBUTES&#xFF0C;&#x8FD9;&#x4E2A;&#x7ED3;&#x6784;&#x91CC;&#x9762;&#x6709;&#x5B89;&#x5168;&#x63CF;&#x8FF0;&#x7B26;&#xFF0C;&#x7EE7;&#x627F;&#x5C5E;&#x6027;&#x7B49;&#x3002;</p>
<p>bInheritHandles&#xFF1A;&#x662F;&#x5426;&#x53EF;&#x7EE7;&#x627F;&#xFF08;global switch&#xFF09;&#x3002;If FALSE, no handles from the parent process are inherited by the (newly created) child process. If TRUE, all handles that are marked inheritable will be inherited by the child process. &#xFF08;&#x672A;&#x9A8C;&#x8BC1;&#x662F;&#x5426;&#x8BBE;&#x7F6E;false&#x540E;&#x5B50;&#x7EBF;&#x7A0B;handle&#x518D;&#x8BBE;&#x7F6E;true&#x4E5F;&#x662F;&#x4E0D;&#x53EF;&#x7EE7;&#x627F;&#x7684;&#xFF09;</p>
<p>dwCreationFlags&#xFF1A;process&#x7684;&#x6807;&#x5FD7;&#x4F4D;&#x3002;&#x4E00;&#x4E9B;&#x6709;&#x610F;&#x601D;&#x7684;&#x4F4D;&#xFF1A;</p>
<pre><code class="lang-c++">DEBUG_PROCESS : &#x6807;&#x5FD7;&#x5F53;&#x524D;&#x8FDB;&#x7A0B;&#x7684;&#x7236;&#x8FDB;&#x7A0B;&#x4E3A;&#x4E00;&#x4E2A;&#x8C03;&#x8BD5;&#x5668;&#xFF0C;&#x5F53;&#x524D;&#x8FDB;&#x7A0B;&#x53CA;&#x6240;&#x6709;&#x7684;&#x5B50;&#x8FDB;&#x7A0B;&#x90FD;&#x662F;&#x88AB;&#x8C03;&#x8BD5;&#x8FDB;&#x7A0B;&#x3002;
DEBUG_ONLY_THIS_PROCESS : &#x53EA;&#x6709;&#x5F53;&#x524D;&#x8FDB;&#x7A0B;&#x662F;&#x88AB;&#x8C03;&#x8BD5;&#x8FDB;&#x7A0B;&#xFF0C;&#x5B50;&#x8FDB;&#x7A0B;&#x4E0D;&#x4F1A;&#x88AB;&#x8C03;&#x8BD5;&#x3002;
CREATE_PROTECTED_PROCESS : The <span class="hljs-keyword">new</span> process must be run <span class="hljs-keyword">protected</span>
CREATED_PROTECTED_PROCESS : &#x548C;&#x4E0A;&#x9762;&#x7684;&#x5DEE;&#x4E0D;&#x591A;&#xFF0C;&#x4F46;&#x662F;&#x8981;&#x6C42;&#x53EF;&#x6267;&#x884C;&#x6587;&#x4EF6;&#x4E3A;&#x5FAE;&#x8F6F;&#x53EF;&#x6267;&#x884C;&#x5371;&#x673A;&#x3002;
</code></pre>
<p>&#x4E5F;&#x53EF;&#x4EE5;&#x8BBE;&#x7F6E;&#x7EBF;&#x7A0B;&#x4F18;&#x5148;&#x7EA7;&#xFF1A;</p>
<pre><code class="lang-c++">IDLE_PRIORITY_CLASS                      <span class="hljs-number">4</span>
BELOW_NORMAL_PRIORITY_CLASS      <span class="hljs-number">6</span>
NORMAL_PRIORITY_CLASS                  <span class="hljs-number">8</span>
ABOVE_NORMAL_PRIORITY_CLASS      <span class="hljs-number">10</span>
HIGH_PRIORITY_CLASS                      <span class="hljs-number">13</span>
REALTIME_NORMAL_PRIORITY_CLASS <span class="hljs-number">24</span>  <span class="hljs-comment">// &#x7EBF;&#x7A0B;&#x4EE5;&#x7BA1;&#x7406;&#x5458;&#x8FD0;&#x884C;&#x624D;&#x53EF;&#x4EE5;&#x8BBE;&#x7F6E;&#x8FD9;&#x4E2A;&#x4F18;&#x5148;&#x7EA7;&#x3002;</span>
</code></pre>
<p>pEnvironment&#xFF1A;&#x6307;&#x5411;&#x73AF;&#x5883;&#x53D8;&#x91CF;&#x3002;
pCurrentDirectory&#xFF1A;&#x8BBE;&#x7F6E;&#x5F53;&#x524D;&#x76EE;&#x5F55;&#x3002;
&#x53EF;&#x4EE5;&#x4F7F;&#x7528;SetCurrentDirectory&#x66F4;&#x6539;&#x5F53;&#x524D;&#x76EE;&#x5F55;</p>
<pre><code class="lang-c++"><span class="hljs-function">BOOL <span class="hljs-title">SetCurrentDirectory</span><span class="hljs-params">( 
  _In_ PCTSTR pPathName)</span></span>;

<span class="hljs-comment">// &#x67E5;&#x8BE2;</span>
<span class="hljs-function">DWORD <span class="hljs-title">GetCurrentDirectory</span><span class="hljs-params">(
    _In_ DWORD nBufferLength, 
    _Out_ LPTSTR lpBuffer)</span></span>;
</code></pre>
<p>pStartupInfo&#xFF1A;&#x6307;&#x5411;STARTUPINFO&#x6216;STARTUPINFOEX&#x3002;&#x65B0;&#x8FDB;&#x7A0B;&#x7684;&#x4E00;&#x4E9B;&#x8BBE;&#x7F6E;&#xFF0C;&#x5305;&#x62EC;&#x56FE;&#x5F62;&#x5316;&#x8BBE;&#x7F6E;&#x3002;
&#x4F7F;&#x7528; GetStartupInfo&#x4E5F;&#x53EF;&#x4EE5;&#x83B7;&#x5F97;startupinfo&#x3002;</p>
<pre><code class="lang-c++"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> _STARTUPINFO { 
  DWORD cb; 
  PTSTR lpReserved; 
  PTSTR lpDesktop; 
  PTSTR lpTitle; 
  DWORD dwX; 
  DWORD dwY; 
  DWORD dwXSize; 
  DWORD dwYSize; 
  DWORD dwXCountChars; 
  DWORD dwYCountChars; 
  DWORD dwFillAttribute; 
  DWORD dwFlags; 
  WORD wShowWindow; 
  WORD cbReserved2; 
  PBYTE lpReserved2; 
  HANDLE hStdInput; 
  HANDLE hStdOutput; 
  HANDLE hStdError;
} STARTUPINFO, *PSTARTUPINFO;

<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> _STARTUPINFOEX { 
  STARTUPINFO StartupInfo; 
  PPROC_THREAD_ATTRIBUTE_LIST pAttributeList; 
} STARTUPINFOEXW, *LPSTARTUPINFOEXW;

STARTUPINFO si = { <span class="hljs-keyword">sizeof</span>(si) }; 
CreateProcess(..., &amp;si, ...);
</code></pre>
<p>process create demo code&#xFF1A;</p>
<pre><code class="lang-c++">WCHAR name[] = <span class="hljs-string">L&quot;notepad&quot;</span>; 

STARTUPINFO si = { <span class="hljs-keyword">sizeof</span>(si) };  <span class="hljs-comment">// &#x8FDB;&#x7A0B;&#x521D;&#x59CB;&#x5316;&#x4FE1;&#x606F;</span>
PROCESS_INFORMATION pi; <span class="hljs-comment">// &#x63A5;&#x53D7;&#x8FD4;&#x56DE;&#x7684;&#x8FDB;&#x7A0B;&#x4FE1;&#x606F;</span>

BOOL success = ::CreateProcess(<span class="hljs-literal">nullptr</span>, name, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, FALSE, <span class="hljs-number">0</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, &amp;si, &amp;pi); 

<span class="hljs-keyword">if</span> (!success) {
                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Error creating process: %d\n&quot;</span>, 
           ::GetLastError()); 
} <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Process created. PID=%d\n&quot;</span>, pi.dwProcessId);
              <span class="hljs-comment">// WaitForSingleObject </span>
              <span class="hljs-comment">// &#x6302;&#x8D77;&#x8FDB;&#x7A0B;</span>
              ::WaitForSingleObject(pi.hProcess, INFINITE);  <span class="hljs-comment">// INFINITE&#xFF08;-1&#xFF09;&#x4E00;&#x76F4;&#x7B49;&#x4E0B;&#x53BB;</span>
              <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Notepad terminated.\n&quot;</span>);
        ::CloseHandle(pi.hProcess);
        ::CloseHandle(pi.hThread);
}
</code></pre>
<pre><code class="lang-c++">DWORD rv = ::WaitForSingleObject(pi.hProcess, <span class="hljs-number">10000</span>); 
<span class="hljs-keyword">if</span> (rv == WAIT_TIMEOUT)
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Notepad still running...\n&quot;</span>); 
<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rv == WAIT_OBJECT_0)
  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Notepad terminated.\n&quot;</span>); 
<span class="hljs-keyword">else</span> <span class="hljs-comment">// WAIT_ERROR (unlikely in this case)</span>
  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Error! %d\n&quot;</span>, ::GetLastError());
</code></pre>
<h4 id="handle-inheritance">Handle Inheritance</h4>
<p>&#x5171;&#x4EAB;&#x8FDB;&#x7A0B;&#x53E5;&#x67C4;&#x7684;&#x7B2C;&#x4E09;&#x79CD;&#x65B9;&#x5F0F;&#xFF1A;&#x8BBE;&#x7F6E;bInheritHandles&#x4E3A;True&#xFF0C;&#x7236;&#x8FDB;&#x7A0B;&#x521B;&#x5EFA;&#x5B50;&#x8FDB;&#x7A0B;&#x7684;&#x65F6;&#x5019;&#x4F1A;&#x628A;&#x53EF;&#x7EE7;&#x627F;&#x7684;&#x8FDB;&#x7A0B;&#x53E5;&#x67C4;&#x590D;&#x5236;&#x5230;&#x5B50;&#x8FDB;&#x7A0B;&#x7684;&#x53E5;&#x67C4;&#x8868;&#x3002;</p>
<p>&#x5982;&#x4F55;&#x8BBE;&#x7F6E;&#x8FDB;&#x7A0B;&#x53EF;&#x4EE5;&#x7EE7;&#x627F;&#xFF1F;
a. &#x521B;&#x5EFA;&#x8FD9;&#x4E2A;&#x8FDB;&#x7A0B;&#x7684;&#x65F6;&#x5019;&#x8BBE;&#x7F6E;SECURITY_ATTRIBUTES&#x4E2D;&#x7684;bInheritHandles&#x4E3A;true</p>
<pre><code class="lang-c++">SECURITY_ATTRIBUTES sa = { <span class="hljs-keyword">sizeof</span>(sa) }; 
sa.bInheritHandles = TRUE;
HANDLE h = ::CreateEvent(&amp;sa, FALSE, FALSE, <span class="hljs-literal">nullptr</span>);
<span class="hljs-comment">// handle h will be inherited by child processes</span>
</code></pre>
<p>b. &#x5BF9;&#x5DF2;&#x5B58;&#x5728;&#x7684;&#x8FDB;&#x7A0B;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;SetHandleInformation&#x8BBE;&#x7F6E;&#x53EF;&#x7EE7;&#x627F;&#x5C5E;&#x6027;</p>
<pre><code class="lang-c++">::SetHandleInformation(h, HANDLE_FLAG_INHERIT , HANDLE_FLAG_INHERIT);
</code></pre>
<p>c. open&#x51FD;&#x6570;&#x4E5F;&#x53EF;&#x4EE5;&#x8BBE;&#x7F6E;&#x53EF;&#x7EE7;&#x627F;&#x5C5E;&#x6027;&#xFF08;&#x901A;&#x8FC7;&#x5171;&#x4EAB;name&#x5171;&#x4EAB;&#x53E5;&#x67C4;&#x7684;&#x65B9;&#x5F0F;&#xFF09;</p>
<pre><code class="lang-c++">HANDLE h = ::OpenEvent(EVENT_ALL_ACCESS, TRUE,  <span class="hljs-string">L&quot;MyEvent&quot;</span>);<span class="hljs-comment">// inheritable</span>
</code></pre>
<p>&#x5B58;&#x5728;&#x7684;&#x4E00;&#x4E2A;&#x95EE;&#x9898;&#xFF1A;&#x5B50;&#x8FDB;&#x7A0B;&#x4E0D;&#x77E5;&#x9053;&#x5B83;&#x7EE7;&#x627F;&#x4E86;&#x54EA;&#x4E9B;&#x53E5;&#x67C4;&#xFF1F;</p>
<p>&#x53EF;&#x4EE5;&#x901A;&#x8FC7;cmdline&#x4F20;&#x9012;&#x53C2;&#x6570;&#x6765;&#x4F20;&#x9012;&#x53E5;&#x67C4;&#x3002;</p>
<p>Demo:</p>
<pre><code class="lang-c++"><span class="hljs-comment">// &#x8BBE;&#x7F6E;&#x53EF;&#x7EE7;&#x627F;&#x5C5E;&#x6027;</span>
::SetHandleInformation(m_hSharedMem.get(), HANDLE_FLAG_INHERIT, HANDLE_FLAG_INHERIT);

<span class="hljs-comment">// &#x8BBE;&#x7F6E;&#x5B50;&#x8FDB;&#x7A0B;</span>
STARTUPINFO si = { <span class="hljs-keyword">sizeof</span>(si) }; PROCESS_INFORMATION pi;
<span class="hljs-comment">// build command line </span>
WCHAR path[MAX_PATH]; 
::GetModuleFileName(<span class="hljs-literal">nullptr</span>, path, MAX_PATH); <span class="hljs-comment">// &#x8FD4;&#x56DE;&#x53EF;&#x6267;&#x884C;&#x6587;&#x4EF6; fullpath &#x5230; path</span>
WCHAR handle[<span class="hljs-number">16</span>]; <span class="hljs-comment">// &#x8BBE;&#x7F6E;&#x53E5;&#x67C4;</span>
<span class="hljs-comment">// &#x628A;&#x5171;&#x4EAB;&#x7684;&#x53E5;&#x67C4;&#x7684;value&#x8F6C;&#x6362;&#x4E3A;&#x5B57;&#x7B26;&#x4E32;</span>
::_itow_s((<span class="hljs-keyword">int</span>)(ULONG_PTR)m_hSharedMem.get(), handle, <span class="hljs-number">10</span>); <span class="hljs-comment">// Integer to Wide Char</span>
::wcscat_s(path, <span class="hljs-string">L&quot; &quot;</span>); 
::wcscat_s(path, handle); <span class="hljs-comment">// cmdline </span>

<span class="hljs-comment">// &#x7EE7;&#x627F;&#x7684;&#x53E5;&#x67C4;&#x548C;&#x7236;&#x8FDB;&#x7A0B;&#x6709;&#x76F8;&#x540C;&#x7684;&#x53E5;&#x67C4;value</span>
<span class="hljs-comment">// Remember that an inherited handle always has the same value as in the original process.</span>
<span class="hljs-comment">// This is possible because the new process handle table is initially empty, so the entry is definitely unused.</span>

<span class="hljs-comment">// now create the process</span>
<span class="hljs-keyword">if</span> (::CreateProcess(<span class="hljs-literal">nullptr</span>, path, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, TRUE, <span class="hljs-number">0</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, &amp;si, &amp;pi)) {
  <span class="hljs-comment">// close unneeded handles </span>
  ::CloseHandle(pi.hProcess); 
  ::CloseHandle(pi.hThread);
}<span class="hljs-keyword">else</span>{
  MessageBox(<span class="hljs-string">L&quot;Failed to create new process&quot;</span>, <span class="hljs-string">L&quot;Inherit Sharing&quot;</span>);
}
</code></pre>
<p>&#x5B50;&#x8FDB;&#x7A0B;&#x89E3;&#x6790;&#xFF1A;</p>
<pre><code class="lang-c++"><span class="hljs-keyword">int</span> count; 
PWSTR* args = ::CommandLineToArgvW(::GetCommandLine(), &amp;count); <span class="hljs-comment">// GetCommandLine()&#x83B7;&#x53D6;&#x53C2;&#x6570;</span>
<span class="hljs-comment">// CommandLineToArgvW&#x7528;&#x6765;&#x89E3;&#x6790;cmdline</span>
<span class="hljs-keyword">if</span> (count == <span class="hljs-number">1</span>) {
    <span class="hljs-comment">// &quot;master&quot; instance</span>
    m_hSharedMem.reset(::CreateFileMapping(INVALID_HANDLE_VALUE,<span class="hljs-literal">nullptr</span>, PAGE_READWRITE, <span class="hljs-number">0</span>, <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">16</span>, <span class="hljs-literal">nullptr</span>)); 
  <span class="hljs-comment">// CreateFileMapping &#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x5171;&#x4EAB;&#x5185;&#x5B58;</span>
}<span class="hljs-keyword">else</span>{
  <span class="hljs-comment">// first &quot;real&quot; argument is inherited handle value</span>
  m_hSharedMem.reset((HANDLE)(ULONG_PTR)::_wtoi(args[<span class="hljs-number">1</span>]));
}
::LocalFree(args);
</code></pre>
<h4 id="process-drive-directories">Process Drive Directories</h4>
<p>&#x4F7F;&#x7528;SetCurrentDirectory&#x548C;GetCurrentDirectory&#x53EF;&#x8BBE;&#x7F6E;&#x548C;&#x5F97;&#x5230;&#x5F53;&#x524D;&#x76EE;&#x5F55;&#xFF0C;&#x5BF9;&#x76F8;&#x5BF9;&#x8DEF;&#x5F84;&#x8FD0;&#x884C;&#x7684;process&#xFF0C;&#x4F1A;&#x5148;&#x4ECE;&#x8FD9;&#x4E2A;directory&#x52A0;&#x8F7D;&#x6587;&#x4EF6;&#x3002;</p>
<p>&#x5BF9;&#xFF1A;c:mydata.txt &#xFF0C; &#x53EF;&#x4EE5;&#x4F7F;&#x7528;GetFullPathName&#x83B7;&#x53D6;fullpath </p>
<pre><code class="lang-c++"><span class="hljs-function">DWORD <span class="hljs-title">GetFullPathNameW</span><span class="hljs-params">(
  _In_ LPCWSTR lpFileName, 
  _In_ DWORD nBufferLength, 
  _Out_ LPWSTR lpBuffer, 
  _Outptr_opt_ LPWSTR* lpFilePart)</span></span>;
</code></pre>
<pre><code class="lang-c++">WCHAR path[MAX_PATH];
::GetFullPathName(<span class="hljs-string">L&quot;c:mydata.txt&quot;</span>, MAX_PATH, path, <span class="hljs-literal">nullptr</span>);
<span class="hljs-comment">// &#x8FD4;&#x56DE; c:Win10SysProg\mydata.txt</span>
</code></pre>
<p>&#x4F7F;&#x7528;GetEnvironmentStrings&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x8FD4;&#x56DE;</p>
<p>=C:=C:\Dev\Win10SysProg 
=D:=D:\Temp</p>
<h4 id="process-and-thread-attributes">Process (and Thread) Attributes</h4>
<p>STARTUPINFO&#x4FE1;&#x606F;&#xFF0C;&#x53EF;&#x4EE5;&#x5BF9;&#x8FD9;&#x4E2A;&#x7ED3;&#x6784;&#x8FDB;&#x884C;&#x6269;&#x5C55;&#xFF1A;STARTUPINFOX</p>
<pre><code class="lang-c++"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> _STARTUPINFOEX { 
  STARTUPINFO StartupInfo; 
  PPROC_THREAD_ATTRIBUTE_LIST pAttributeList; <span class="hljs-comment">// &#x6307;&#x5411;&#x4E00;&#x4E2A;&#x5C5E;&#x6027;&#x5217;&#x8868;</span>
} STARTUPINFOEXW, *LPSTARTUPINFOEXW;
</code></pre>
<p>&#x521B;&#x5EFA;&#x4E00;&#x4E2A;STARTUPINFOX&#x7ED3;&#x6784;&#x4F53;&#x7684;&#x6B65;&#x9AA4;&#x5982;&#x4E0B;&#xFF1A;</p>
<ol>
<li>Allocate and initialize an attribute list with InitializeProcThreadAttributeList.</li>
</ol>
<pre><code class="lang-c++"><span class="hljs-function">BOOL <span class="hljs-title">InitializeProcThreadAttributeList</span><span class="hljs-params">(
    _Out_ PPROC_THREAD_ATTRIBUTE_LIST pAttributeList,
  _In_ DWORD dwAttributeCount, 
  _Reserved_ DWORD dwFlags, <span class="hljs-comment">// must be zero </span>
  PSIZE_T pSize)</span></span>;
</code></pre>
<p>demo: &#x8C03;&#x7528;&#x4E24;&#x6B21;InitializeProcThreadAttributeList</p>
<pre><code class="lang-c++">SIZE_T size; <span class="hljs-comment">// get required size </span>
::InitializeProcThreadAttributeList(<span class="hljs-literal">nullptr</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, &amp;size); <span class="hljs-comment">// allocate the required size auto </span>
attlist = (PPROC_THREAD_ATTRIBUTE_LIST)<span class="hljs-built_in">malloc</span>(size); <span class="hljs-comment">// initialize </span>
::InitializeProcThreadAttributeList(attlist, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, &amp;size); <span class="hljs-comment">// just one attribute</span>
</code></pre>
<ol>
<li>Add attributes as required by calling UpdateProcThreadAttribute once for each attribute.</li>
</ol>
<pre><code class="lang-c++"><span class="hljs-function">BOOL <span class="hljs-title">UpdateProcThreadAttribute</span><span class="hljs-params">(
    _Inout_ PPROC_THREAD_ATTRIBUTE_LIST pAttributeList, 
  _In_ DWORD dwFlags, <span class="hljs-comment">// must be zero </span>
  _In_ DWORD_PTR Attribute, 
  _In_ PVOID pValue, 
  _In_ SIZE_T cbSize, 
  _Out_ PVOID pPreviousValue, <span class="hljs-comment">// must be NULL </span>
  _In_opt_ PSIZE_T pReturnSize)</span></span>; <span class="hljs-comment">// must be NULL</span>
</code></pre>
<p>demo: &#x901A;&#x8FC7;PROC_THREAD_ATTRIBUTE_PARENT_PROCESS&#x8BBE;&#x7F6E;&#x8FD9;&#x4E2A;&#x8FDB;&#x7A0B;&#x7684;&#x7236;&#x8FDB;&#x7A0B;</p>
<pre><code class="lang-c++">HANDLE hParent = ...;
::UpdateProcThreadAttribute(attlist, <span class="hljs-number">0</span>, PROC_THREAD_ATTRIBUTE_PARENT_PROCESS,&amp;hParent, <span class="hljs-keyword">sizeof</span>(hParent), <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);
</code></pre>
<blockquote>
<p>&#x591A;&#x4E2A;Attribute&#x5982;&#x4F55;&#x8C03;&#x7528;&#x8FD9;&#x4E2A;API&#xFF1F;</p>
</blockquote>
<ol>
<li><p>Set the pAttribute member of STARTUPINFOEX to point to the attribute list.</p>
</li>
<li><p>Call CreateProcess with the extended structure, not forgetting to add the flag EXTENDED_STARTUPINFO_PRESENT to the creation flags (sixth parameter to CreateProcess)</p>
</li>
</ol>
<pre><code class="lang-c++">STARTUPINFOEX si = { <span class="hljs-keyword">sizeof</span>(si) }; 
si.lpAttributeList = attlist;     <span class="hljs-comment">// &#x6307;&#x9488;&#x6307;&#x5411;</span>
PROCESS_INFORMATION pi; 
<span class="hljs-comment">// 4. &#x9700;&#x8981;&#x8BBE;&#x7F6E;EXTENDED_STARTUPINFO_PRESENT&#x6807;&#x5FD7;&#x4F4D;&#xFF0C;&#x4E0D;&#x8BBE;&#x7F6E;&#x4E0D;&#x751F;&#x6548;&#x3002;</span>
WCHAR name[] = <span class="hljs-string">L&quot;Notepad&quot;</span>;
::CreateProcess(<span class="hljs-literal">nullptr</span>, name, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, FALSE, EXTENDED_STARTUPINFO_PRESENT, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, (STARTUPINFO*)&amp;si, &amp;pi);
</code></pre>
<ol>
<li>Delete the attribute list with DeleteProcThreadAttributeList.</li>
</ol>
<pre><code class="lang-c++">::DeleteProcThreadAttributeList(attList); 
::<span class="hljs-built_in">free</span>(attList);
</code></pre>
<p>&#x5B8C;&#x6574;demo:</p>
<pre><code class="lang-c++"><span class="hljs-function">DWORD <span class="hljs-title">CreateProcessWithParent</span><span class="hljs-params">(PWSTR name, DWORD parentPid)</span> </span>{
    HANDLE hParent = ::OpenProcess(PROCESS_CREATE_PROCESS, FALSE, parentPid); 
  <span class="hljs-keyword">if</span> (!hParent) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;

    PROCESS_INFORMATION pi = { <span class="hljs-number">0</span> }; 
  PPROC_THREAD_ATTRIBUTE_LIST attList = <span class="hljs-literal">nullptr</span>;

    <span class="hljs-keyword">do</span> {
    SIZE_T size = <span class="hljs-number">0</span>; 
    ::InitializeProcThreadAttributeList(<span class="hljs-literal">nullptr</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, &amp;size); 
    <span class="hljs-keyword">if</span> (size == <span class="hljs-number">0</span>) <span class="hljs-keyword">break</span>;

        attList = (PPROC_THREAD_ATTRIBUTE_LIST)<span class="hljs-built_in">malloc</span>(size); 
    <span class="hljs-keyword">if</span> (!attList) <span class="hljs-keyword">break</span>;

        <span class="hljs-keyword">if</span> (!::InitializeProcThreadAttributeList(attList, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, &amp;size)) <span class="hljs-keyword">break</span>;

        <span class="hljs-keyword">if</span> (!::UpdateProcThreadAttribute(attList, <span class="hljs-number">0</span>, PROC_THREAD_ATTRIBUTE_PARENT_PROCESS, &amp;hParent, <span class="hljs-keyword">sizeof</span>(hParent), <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>)) <span class="hljs-keyword">break</span>;

        STARTUPINFOEX si = { <span class="hljs-keyword">sizeof</span>(si) }; 
    si.lpAttributeList = attList; 
    <span class="hljs-keyword">if</span> (!::CreateProcess(<span class="hljs-literal">nullptr</span>, name, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, FALSE, EXTENDED_STARTUPINFO_PRESENT, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, (STARTUPINFO*)&amp;si,&amp;pi)) <span class="hljs-comment">// EXTENDED_STARTUPINFO_PRESENT</span>
      <span class="hljs-keyword">break</span>;  
  ::CloseHandle(pi.hProcess); ::CloseHandle(pi.hThread); 
} <span class="hljs-keyword">while</span> (<span class="hljs-literal">false</span>);

    ::CloseHandle(hParent); 
    <span class="hljs-keyword">if</span> (attList) {
        ::DeleteProcThreadAttributeList(attList);
        ::<span class="hljs-built_in">free</span>(attList); 
    } 
  <span class="hljs-keyword">return</span> pi.dwProcessId;
}
</code></pre>
<p>Demo2: &#x8BBE;&#x7F6E; PROC_THREAD_ATTRIBUTE_MITIGATION_POLICY&#x3002; process mitigations</p>
<pre><code class="lang-c++"><span class="hljs-function">DWORD <span class="hljs-title">CreateProcessWithMitigations</span><span class="hljs-params">(PWSTR name, DWORD64 mitigation)</span> </span>{ 
  PROCESS_INFORMATION pi = { <span class="hljs-number">0</span> }; 
  PPROC_THREAD_ATTRIBUTE_LIST attList = <span class="hljs-literal">nullptr</span>;
    <span class="hljs-keyword">do</span> {
        SIZE_T size = <span class="hljs-number">0</span>; 
    ::InitializeProcThreadAttributeList(<span class="hljs-literal">nullptr</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, &amp;size); 
    <span class="hljs-keyword">if</span> (size == <span class="hljs-number">0</span>) <span class="hljs-keyword">break</span>;

        attList = (PPROC_THREAD_ATTRIBUTE_LIST)<span class="hljs-built_in">malloc</span>(size); 
    <span class="hljs-keyword">if</span> (!attList) <span class="hljs-keyword">break</span>;

        <span class="hljs-keyword">if</span> (!::InitializeProcThreadAttributeList(attList, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, &amp;size)) <span class="hljs-keyword">break</span>;

        <span class="hljs-keyword">if</span> (!::UpdateProcThreadAttribute(attList, <span class="hljs-number">0</span>, PROC_THREAD_ATTRIBUTE_MITIGATION_POLICY, &amp;mitigation, <span class="hljs-keyword">sizeof</span>(mitigation), <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>)) <span class="hljs-keyword">break</span>;

        STARTUPINFOEX si = { <span class="hljs-keyword">sizeof</span>(si) }; 
    si.lpAttributeList = attList; 
    <span class="hljs-keyword">if</span> (!::CreateProcess(<span class="hljs-literal">nullptr</span>, name, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, FALSE, EXTENDED_STARTUPINFO_PRESENT, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, (STARTUPINFO*)&amp;si, &amp;pi)) <span class="hljs-keyword">break</span>; 
    ::CloseHandle(pi.hProcess); 
    ::CloseHandle(pi.hThread); 
  } <span class="hljs-keyword">while</span> (<span class="hljs-literal">false</span>);
    <span class="hljs-keyword">if</span> (attList) { 
    ::DeleteProcThreadAttributeList(attList); ::<span class="hljs-built_in">free</span>(attList); 
  } 
  <span class="hljs-keyword">return</span>     pi.dwProcessId;
}


WCHAR name[] = <span class="hljs-string">L&quot;notepad&quot;</span>; 
<span class="hljs-keyword">auto</span> pid = CreateProcessWithMitigations(name, PROCESS_CREATION_MITIGATION_POLICY_WIN32K_SYSTEM_CALL_DISABLE_ALWAYS_ON);
</code></pre>
<p> the specific mitigation prevents calls to Win32k.sys&#xFF0C;&#x53EF;&#x4EE5;&#x62E6;&#x622A;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x3002;</p>
<h4 id="protected-and-ppl-processes">Protected and PPL Processes</h4>
<p>Protected Processes Light</p>
<p>&#x6700;&#x521D;&#x8BBE;&#x7F6E;&#x662F;&#x4E3A;&#x4E86;&#x6570;&#x5B57;&#x7248;&#x6743;</p>
<p>Only Microsoft-signed executables with a certain Extended Key Usage (EKU) were allowed to execute protected.
access masks&#xFF1A;PROCESS_QUERY_LIMITED_INFORMATION, PROCESS_SET_LIMITED_INFORMATION, PROCESS_SUSPEND_RESUME and PROCESS_TERMINATE.</p>
<p>windows8&#x4E4B;&#x540E;&#x6269;&#x5C55;&#xFF1A;Protected Processes Light (PPL),</p>
<ul>
<li>higher level protected processes have full access to lower level ones</li>
<li>possible to run third party anti-malware services</li>
<li>Protected and PPL processes cannot load arbitrary DLLs,All DLLs loaded by protected/PPL processes must be signed properly</li>
</ul>
<p>&#x901A;&#x8FC7;&#x9650;&#x5236;access mask&#x4FDD;&#x62A4;&#x8FDB;&#x7A0B;</p>
<p>ppl levels:</p>
<p><img src="README/image-20210913221329649.png" alt="image-20210913221329649"></p>
<p>&#x521B;&#x5EFA;ppl&#x8FDB;&#x7A0B;&#xFF1A; CREATE_PROTECTED_PROCESS &#x6807;&#x5FD7;&#x4F4D;</p>
<blockquote>
<p>Windows Internals 7th edition Part 1 cp3</p>
</blockquote>
<h4 id="uwp-processes">UWP Processes</h4>
<p>Universal Windows Platform processes</p>
<ul>
<li>run under AppContainer (limits what it can do and what it can access)</li>
<li><p>managed by the Process Lifetime Manager (PLM)</p>
</li>
<li><p>&#x53D7;foreground/background&#x5F71;&#x54CD;</p>
</li>
<li>&#x5355;&#x4F8B;</li>
<li>Microsoft Store--&#x5FAE;&#x8F6F;&#x5546;&#x5E97;&#x5E94;&#x7528;&#xFF0C;&#x9002;&#x914D;&#x6240;&#x6709;Windows&#x5E73;&#x53F0;&#x7684;&#x5E94;&#x7528;&#x3002;</li>
</ul>
<p>&#x901A;&#x8FC7;&#x5305;&#xFF08;&#x53EF;&#x6267;&#x884C;&#x6587;&#x4EF6;&#xFF0C;DLL&#xFF0C;&#x8D44;&#x6E90;&#x6587;&#x4EF6;&#xFF09;&#x521B;&#x5EFA;&#x8FDB;&#x7A0B;, &#x4E0D;&#x80FD;&#x76F4;&#x63A5;&#x901A;&#x8FC7;&#x547D;&#x4EE4;&#x884C;&#x8FD0;&#x884C;&#xFF0C;&#x4F1A;&#x63D0;&#x793A;&#x7F3A;&#x5C11;&#x5305;&#x540D;&#x79F0;&#x3002;&#x53EF;&#x4EE5;&#x8C03;&#x7528;COM&#x63A5;&#x53E3;&#x7B49;&#x6307;&#x5B9A;&#x5305;&#x540D;&#x79F0;&#x521B;&#x5EFA;&#x8FDB;&#x7A0B;&#x3002; &#x8C03;&#x7528;Windows runtime API&#x521B;&#x5EFA;UWP&#x8FDB;&#x7A0B;&#x3002;</p>
<p>&#x8C03;&#x7528;Windows Runtime API&#x7684;&#x65B9;&#x6CD5;&#xFF1A;</p>
<ol>
<li><p>Directly, by instantiating the proper classes and working with the low level object factories until an instance is created and then use normal COM calls.</p>
</li>
<li><p>Use the Windows Runtime Library (WRL) C++ wrappers and helpers. </p>
</li>
<li><p>Use the C++/CX language extensions, that provide an easy access to WinRT by extending C++ in a non-standard way.</p>
</li>
<li><p>Use the CppWinRT library, that provides relatively easy access to the WinRT APIs with standard C++ only. </p>
</li>
</ol>
<p>&#x4F18;&#x5148;&#x8003;&#x8651;2&#xFF0C;3&#xFF0C;4</p>
<p>&#x4F7F;&#x7528;4 CppWinRT &#x521B;&#x5EFA;UWP&#x8FDB;&#x7A0B;&#xFF1A;</p>
<p>&#x5BFC;&#x5165;&#x5305;&#x548C;&#x547D;&#x540D;&#x7A7A;&#x95F4;</p>
<pre><code class="lang-c++"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;winrt/Windows.Foundation.h&gt;</span> </span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;winrt/Windows.Foundation.Collections.h&gt;</span> </span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;winrt/Windows.ApplicationModel.h&gt;</span> </span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;winrt/Windows.Management.Deployment.h&gt;</span> </span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;winrt/Windows.Storage.h&gt;</span></span>

<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> winrt; 
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> winrt::Windows::Management::Deployment; 
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> winrt::Windows::ApplicationModel;
</code></pre>
<p>&#x4F7F;&#x7528; winrt::Windows::Management::Deployment &#x4E0B;&#x7684;PackageMangement&#x679A;&#x4E3E;&#x53EF;&#x7528;&#x5305;&#xFF1A;</p>
<pre><code class="lang-c++"><span class="hljs-keyword">auto</span> packages = PackageManager().FindPackagesForUser(<span class="hljs-string">L&quot;&quot;</span>); <span class="hljs-comment">// L&quot;&quot; -&gt; &#x5F53;&#x524D;&#x7528;&#x6237;</span>

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> package : packages) {
    <span class="hljs-keyword">auto</span> item = <span class="hljs-built_in">std</span>::make_shared&lt;AppItem&gt;();
  <span class="hljs-comment">/*
  struct AppItem { 
    CString Name, Publisher, InstalledLocation, FullName; 
    winrt::Windows::ApplicationModel::PackageVersion Version; 
    winrt::Windows::Foundation::DateTime InstalledDate; bool IsFramework; 
  };*/</span>

    item-&gt;InstalledLocation = package.InstalledLocation().Path().c_str(); 
  item-&gt;FullName = package.Id().FullName().c_str(); 
  item-&gt;InstalledDate = package.InstalledDate(); 
  item-&gt;IsFramework = package.IsFramework(); 
  item-&gt;Name = package.Id().Name().c_str(); 
  item-&gt;Publisher = package.Id().Publisher().c_str(); 
  item-&gt;Version = package.Id().Version();
    m_AllPackages.push_back(item);
}
</code></pre>
<p>CView::RunApp</p>
<pre><code class="lang-c++"><span class="hljs-keyword">bool</span> CView::RunApp(PCWSTR fullPackageName) {
    PACKAGE_INFO_REFERENCE pir; 
  <span class="hljs-keyword">int</span> error = ::OpenPackageInfoByFullName(fullPackageName, <span class="hljs-number">0</span>, &amp;pir); <span class="hljs-comment">// pir</span>
  <span class="hljs-keyword">if</span> (error != ERROR_SUCCESS) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

  <span class="hljs-comment">// &#x6839;&#x636E;app id&#x8C03;&#x7528;&#x5305;&#x91CC;&#x9762;&#x7684;application</span>
  UINT32 len = <span class="hljs-number">0</span>; 
  error = ::GetPackageApplicationIds(pir, &amp;len, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>); <span class="hljs-comment">// &#x83B7;&#x53D6;size</span>
  <span class="hljs-keyword">if</span> (error != ERROR_INSUFFICIENT_BUFFER) <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">auto</span> buffer = <span class="hljs-built_in">std</span>::make_unique&lt;BYTE[]&gt;(len); 
  UINT32 count; 
  error = ::GetPackageApplicationIds(pir, &amp;len, buffer.get(), &amp;count);  <span class="hljs-comment">// buffer</span>
  <span class="hljs-keyword">if</span> (error != ERROR_SUCCESS) <span class="hljs-keyword">break</span>;

  <span class="hljs-comment">// &#x542F;&#x52A8;</span>
  CComPtr&lt;IApplicationActivationManager&gt; mgr; 
  <span class="hljs-keyword">auto</span> hr = mgr.CoCreateInstance(CLSID_ApplicationActivationManager); 
  <span class="hljs-comment">// &#x901A;&#x8FC7;IApplicationActivationManager&#x521B;&#x5EFA;&#x5B9E;&#x4F8B;</span>
  <span class="hljs-keyword">if</span> (FAILED(hr)) <span class="hljs-keyword">break</span>;

    DWORD pid; 
  <span class="hljs-comment">// &#x6FC0;&#x6D3B;</span>
  hr = mgr-&gt;ActivateApplication((PCWSTR)(buffer.get() + <span class="hljs-keyword">sizeof</span>(ULONG_PTR)), <span class="hljs-comment">//skip the first 4 bytes</span>

                                <span class="hljs-literal">nullptr</span>, AO_NOERRORUI, &amp;pid);

  <span class="hljs-comment">// &#x91CA;&#x653E;</span>
  ::ClosePackageInfo(pir);
}
</code></pre>
<p>UWP&#x8FDB;&#x7A0B;&#x7684;&#x7236;&#x8FDB;&#x7A0B;&#x4E3A;Svchost.exe&#xFF08;DCOM Launch service&#xFF09;</p>
<h4 id="minimal-and-pico-processes">Minimal and Pico Processes</h4>
<p>Minimal processes&#xFF1A;&#x53EA;&#x6709;a user mode address space &#xFF0C; &#x53EA;&#x80FD;&#x7531;kernel&#x521B;&#x5EFA;&#x3002;</p>
<p>Pico processes&#xFF1A;&#x5728;minimal processes&#x7684;&#x57FA;&#x7840;&#x4E0A;&#x591A;&#x4E86;&#x4E00;&#x4E2A;pico provider.(&#x5904;&#x7406;Linux&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x7684;kernel driver&#xFF0C;&#x5904;&#x7406;wsl linux system call&#x4E3A;Windows system calls ) wsl&#x7684;&#x57FA;&#x7840;&#x3002;</p>
<h3 id="process-termination">Process Termination</h3>
<p>&#x8FDB;&#x7A0B;&#x7ED3;&#x675F;&#xFF1A;</p>
<ul>
<li>&#x91CA;&#x653E;&#x6240;&#x6709;&#x5185;&#x5B58;&#x7A7A;&#x95F4;</li>
<li>&#x6E05;&#x9664;&#x53E5;&#x67C4;&#x8868;&#xFF0C;&#x89E3;&#x9664;&#x5360;&#x7528;&#x3002;</li>
</ul>
<p>&#x8FDB;&#x7A0B;&#x7ED3;&#x675F;&#x53D1;&#x751F;&#x7684;&#x573A;&#x666F;&#xFF1A;</p>
<ul>
<li>All the threads in the process exit or terminate <ul>
<li>unlikely to happen in normal Windows programming.</li>
</ul>
</li>
<li>Any thread in the process calls ExitProcess <ul>
<li>main&#x51FD;&#x6570;&#x4E2D;&#x7684;ExitProcess  <code>void ExitProcess(_In_ UINT exitCode);</code></li>
</ul>
</li>
<li>The process is terminated (usually externally but could be because of an unhandled exception) with TerminateProcess.</li>
</ul>
<p>&#x4F7F;&#x7528;GetExitCodeProcess&#x53EF;&#x4EE5;&#x83B7;&#x5F97;&#x4E00;&#x4E2A;&#x8FDB;&#x7A0B;&#x7684;exitcode</p>
<pre><code class="lang-c++"><span class="hljs-function">BOOL <span class="hljs-title">GetExitCodeProcess</span><span class="hljs-params">(
    _In_ HANDLE hProcess, 
  _Out_ LPDWORD lpExitCode <span class="hljs-comment">// exit&#x4E4B;&#x540E;&#x53EF;&#x4EE5;return STILL_ACTIVE.</span>
)</span></span>;
</code></pre>
<blockquote>
<p>&#x4E3A;&#x4EC0;&#x4E48;&#x8FDB;&#x7A0B;&#x9000;&#x51FA;&#x4E4B;&#x540E;&#x8FD8;&#x80FD;&#x6839;&#x636E;&#x53E5;&#x67C4;&#x83B7;&#x5F97;&#x5B83;&#x7684;exitcode?</p>
<p>&#x8C03;&#x7528;ExitProcess&#x4E4B;&#x540E;&#xFF0C;&#x5185;&#x6838;&#x4E2D;&#x6709;&#x5173;&#x8FDB;&#x7A0B;&#x4FE1;&#x606F;&#x7684;&#x7ED3;&#x6784;&#x4F53;&#x4F1A;&#x88AB;&#x7F13;&#x5B58;&#x3002;</p>
</blockquote>
<p>&#x8C03;&#x7528;ExitProcess flow</p>
<ul>
<li>&#x7EC8;&#x6B62;&#x6240;&#x6709;&#x7EBF;&#x7A0B;&#xFF08;&#x4E0D;&#x5305;&#x62EC;calling thread&#xFF09;</li>
<li>&#x8FDB;&#x7A0B;&#x4E2D;&#x6240;&#x6709;&#x8C03;&#x7528;&#x7684;DLL&#x8C03;&#x7528;DllMain&#x5378;&#x8F7D;&#x4E00;&#x4E2A;DLL.</li>
<li>&#x7EC8;&#x6B62;&#x5F53;&#x524D;&#x8FDB;&#x7A0B;&#x548C;calling thread</li>
</ul>
<p>&#x8C03;&#x7528; TerminateProcess &#x5173;&#x95ED;&#x53E6;&#x4E00;&#x4E2A;&#x8FDB;&#x7A0B;, &#x9700;&#x8981; PROCESS_TERMINATE access mask</p>
<pre><code class="lang-c++"><span class="hljs-function">BOOL <span class="hljs-title">TerminateProcess</span><span class="hljs-params">(
    _In_ HANDLE hProcess, 
  _In_ UINT uExitCode)</span></span>;
</code></pre>
<p>&#x548C;ExitProcess&#x7684;&#x533A;&#x522B;&#xFF1A;flow&#x4E2D;&#x4E2D;&#x4E0D;&#x5B58;&#x5728;&#x8C03;&#x7528;dllmain&#x5378;&#x8F7D;DLL</p>
<h3 id="&#x679A;&#x4E3E;&#x8FDB;&#x7A0B;&#xFF1A;">&#x679A;&#x4E3E;&#x8FDB;&#x7A0B;&#xFF1A;</h3>
<h4 id="enumprocesses">EnumProcesses</h4>
<p>&#x5934;&#x6587;&#x4EF6;&#xFF1A;<code>&lt;psapi.h&gt;</code>  &#x53EF;&#x4EE5;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;PID&#x6570;&#x7EC4;&#x3002;</p>
<pre><code class="lang-c++"><span class="hljs-function">BOOL <span class="hljs-title">EnumProcesses</span><span class="hljs-params">(
    _Out_ DWORD *pProcessIds,  
  _In_ DWORD cb,
  _Out_ DWORD *pBytesReturned)</span></span>;
</code></pre>
<p>Demo:</p>
<pre><code class="lang-c++"><span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> MaxCount = <span class="hljs-number">1024</span>; 
DWORD pids[MaxCount]; 
DWORD actualSize; 

<span class="hljs-keyword">if</span>(::EnumProcesses(pids, <span class="hljs-keyword">sizeof</span>(pids), &amp;actualSize)) { 
  <span class="hljs-comment">// assume actualSize &lt; sizeof(pids)</span>

    <span class="hljs-keyword">int</span> count = actualSize / <span class="hljs-keyword">sizeof</span>(DWORD);
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; count; i++) {
    <span class="hljs-comment">// do something with pids[i]</span>
    }
}
</code></pre>
<pre><code class="lang-c++">int maxCount = 256; 
std::unique_ptr&lt;DWORD[]&gt; pids; 
int count = 0;

for (;;) {
    pids = std::make_unique&lt;DWORD[]&gt;(maxCount); // #include &lt;memory&gt;
  DWORD actualSize; 
  if (!::EnumProcesses(pids.get(), maxCount * sizeof(DWORD), &amp;actualSize)) 
      // api &#x8FD4;&#x56DE;false , size&#x592A;&#x5C0F;  
    break;

    count = actualSize / sizeof(DWORD); if (count &lt; maxCount) break;

    // need to resize 
  maxCount *= 2;
}

for (int i = 0; i &lt; count; i++) { 
  // do something with pids[i] 
}
</code></pre>
<p>&#x5229;&#x7528;&#x8FD4;&#x56DE;&#x7684;PID&#x6570;&#x7EC4;&#x83B7;&#x5F97;&#x66F4;&#x591A;&#x8FDB;&#x7A0B;&#x4FE1;&#x606F;&#xFF1A;&#x9700;&#x8981;&#x8C03;&#x7528;openProcess&#x6253;&#x5F00;&#x8FDB;&#x7A0B;&#x3002;</p>
<pre><code class="lang-c++"><span class="hljs-comment">// count is the number of processes </span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; count; i++) {
    DWORD pid = pids[i];

  HANDLE hProcess = ::OpenProcess(PROCESS_QUERY_LIMITED_INFORMATION, FALSE, pid); 
  <span class="hljs-comment">// openProcess</span>
  <span class="hljs-keyword">if</span> (!hProcess) { 
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Failed to open a handle to process %d (error=%d)\n&quot;</span>, pid, ::GetLastError()); 
    <span class="hljs-keyword">continue</span>; 
  }

  <span class="hljs-comment">// &#x83B7;&#x5F97;&#x8FDB;&#x7A0B;&#x542F;&#x52A8;&#x65F6;&#x95F4;</span>
  FILETIME start = { <span class="hljs-number">0</span> }, dummy; 
  ::GetProcessTimes(hProcess, &amp;start, &amp;dummy, &amp;dummy, &amp;dummy); 
  SYSTEMTIME st; 
  ::FileTimeToLocalFileTime(&amp;start, &amp;start); 
  ::FileTimeToSystemTime(&amp;start, &amp;st);

  <span class="hljs-comment">// &#x83B7;&#x5F97;&#x8FDB;&#x7A0B;Full Image Name</span>
  WCHAR exeName[MAX_PATH]; 
  DWORD size = MAX_PATH; 
  DWORD count = ::QueryFullProcessImageName(hProcess, <span class="hljs-number">0</span>, exeName, &amp;size); 

  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;PID: %5d, Start: %d/%d/%d %02d:%02d:%02d Image: %ws\n&quot;</span>, 
         pid, st.wDay, st.wMonth, st.wYear, st.wHour, st.wMinute, st.wSecond, 
         count &gt; <span class="hljs-number">0</span> ? exeName : <span class="hljs-string">L&quot;Unknown&quot;</span>);
}
</code></pre>
<ul>
<li>openProcess&#x9700;&#x8981; PROCESS_QUERY_LIMITED_INFORMATION access mask</li>
</ul>
<p>&#x7528;&#x5230;&#x7684;&#x4E24;&#x4E2A;API&#x539F;&#x578B;&#xFF1A;</p>
<pre><code class="lang-c++"><span class="hljs-function">BOOL <span class="hljs-title">GetProcessTimes</span><span class="hljs-params">(
    _In_ HANDLE hProcess, 
  _Out_ LPFILETIME lpCreationTime, 
  _Out_ LPFILETIME lpExitTime, 
  _Out_ LPFILETIME lpKernelTime, 
  _Out_ LPFILETIME lpUserTime)</span></span>;

<span class="hljs-function">BOOL <span class="hljs-title">QueryFullProcessImageName</span><span class="hljs-params">( 
  _In_ HANDLE hProcess, 
  _In_ DWORD dwFlags, 
  <span class="hljs-comment">// &#x901A;&#x5E38;dwFlags&#x4E3A;0&#xFF0C;&#x4F1A;&#x8FD4;&#x56DE;&#x6B63;&#x5E38;&#x7684;&#x8DEF;&#x5F84;&#x5982;&#xFF1A;C:\Windows\explorer.exe</span>
  <span class="hljs-comment">// &#x53EF;&#x4EE5;&#x8BBE;&#x4E3A;1&#xFF1A;PROCESS_NAME_NATIVE&#xFF0C; &#x8FD4;&#x56DE;&#x7C7B;&#x4F3C;&#xFF1A;\Device\HarddiskVolume3\MyDir\MyApp.exe)</span>
  _Out_ LPTSTR lpExeName, 
  _Inout_ PDWORD lpdwSize <span class="hljs-comment">// initialized to the allocated buffer size,</span>
  <span class="hljs-comment">// the function changes it to the actual number of characters written to the buffer.</span>
)</span></span>;
</code></pre>
<p>tips&#xFF1A;&#x5F00;&#x542F;&#x8FDB;&#x7A0B;&#x7684;Debug privilege&#xFF1A;</p>
<pre><code class="lang-c++"><span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">EnableDebugPrivilege</span><span class="hljs-params">()</span> </span>{
  wil::unique_handle hToken; 
  <span class="hljs-comment">// &#x6253;&#x5F00;token</span>
  <span class="hljs-keyword">if</span> (!::OpenProcessToken(::GetCurrentProcess(), TOKEN_ADJUST_PRIVILEGES,hToken.addressof()))
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

  TOKEN_PRIVILEGES tp;  <span class="hljs-comment">// TOKEN_PRIVILEGES &#x7ED3;&#x6784;&#x4F53;</span>
  tp.PrivilegeCount = <span class="hljs-number">1</span>; 
  tp.Privileges[<span class="hljs-number">0</span>].Attributes = SE_PRIVILEGE_ENABLED; 
  <span class="hljs-keyword">if</span> (!::LookupPrivilegeValue(<span class="hljs-literal">nullptr</span>, SE_DEBUG_NAME, &amp;tp.Privileges[<span class="hljs-number">0</span>].Luid)) 
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

  <span class="hljs-keyword">if</span> (!::AdjustTokenPrivileges(hToken.get(), FALSE, &amp;tp, <span class="hljs-keyword">sizeof</span>(tp), <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>)) 
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; 
  <span class="hljs-keyword">return</span> ::GetLastError() == ERROR_SUCCESS;

}
</code></pre>
<h4 id="toolhelp-functions">Toolhelp Functions</h4>
<p>&#x4E0D;&#x9700;&#x8981;&#x63D0;&#x6743;&#x5C31;&#x53EF;&#x4EE5;&#x83B7;&#x5F97;&#x5F88;&#x591A;&#x4FE1;&#x606F;&#x3002;</p>
<p><code>#include &lt;tlhelp32.h&gt;</code></p>
<p>flow : </p>
<ul>
<li>&#x83B7;&#x5F97;&#x4E00;&#x4E2A;snapshot (&#x8FDB;&#x7A0B;&#x548C;&#x7EBF;&#x7A0B;&#x7684;&#x5FEB;&#x7167;&#xFF09;// CreateToolhelp32Snapshot</li>
</ul>
<pre><code class="lang-c++">HANDLE hSnapshot = ::CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, <span class="hljs-number">0</span>); 
<span class="hljs-comment">// &#x7B2C;&#x4E8C;&#x4E2A;&#x53C2;&#x6570;&#x4E3A;0&#x8868;&#x793A;&#x83B7;&#x5F97;&#x5168;&#x90E8;&#x7EBF;&#x7A0B;&#x548C;&#x8FDB;&#x7A0B;&#x7684;&#x5FEB;&#x7167;</span>
<span class="hljs-keyword">if</span> (hSnapshot == INVALID_HANDLE_VALUE) { 
  <span class="hljs-comment">// handle error </span>
}
</code></pre>
<ul>
<li>&#x679A;&#x4E3E;&#x8FDB;&#x7A0B;&#x4FE1;&#x606F;&#x3002;</li>
</ul>
<pre><code class="lang-c++">PROCESSENTRY32 pe; <span class="hljs-comment">// &#x4ECE;&#x5FEB;&#x7167;&#x83B7;&#x5F97;PROCESSENTRY32&#x7ED3;&#x6784;&#x4F53;</span>
pe.dwSize = <span class="hljs-keyword">sizeof</span>(pe);

<span class="hljs-comment">// &#x679A;&#x4E3E;&#x7B2C;&#x4E00;&#x4E2A;</span>
<span class="hljs-keyword">if</span> (!::Process32First(hSnapshot, &amp;pe)) { 
  <span class="hljs-comment">// unlikely - handle error </span>
}

<span class="hljs-keyword">do</span> {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;PID:%6d (PPID:%6d): %ws (Threads=%d) (Priority=%d)\n&quot;</span>, pe.th32ProcessID,
         pe.th32ParentProcessID, pe.szExeFile, 
         pe.cntThreads, pe.pcPriClassBase); 
} <span class="hljs-keyword">while</span> (::Process32Next(hSnapshot, &amp;pe)); <span class="hljs-comment">// Process32Next</span>

::CloseHandle(hSnapshot);
</code></pre>
<p>PROCESSENTRY32&#x7ED3;&#x6784;&#x4F53;&#x7684;&#x4FE1;&#x606F;&#xFF1A;</p>
<pre><code class="lang-c++"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> tagPROCESSENTRY32 { 
  DWORD dwSize;                             <span class="hljs-comment">// size of structure</span>
  DWORD cntUsage;                         <span class="hljs-comment">// unused</span>
  DWORD th32ProcessID;                 <span class="hljs-comment">// PID</span>
  ULONG_PTR th32DefaultHeapID;<span class="hljs-comment">// unused</span>
  DWORD th32ModuleID;                 <span class="hljs-comment">// unused</span>
  DWORD cntThreads;                     <span class="hljs-comment">// # threads    </span>
  DWORD th32ParentProcessID;     <span class="hljs-comment">// parent PID</span>
  LONG pcPriClassBase;                 <span class="hljs-comment">// Base priority</span>
  DWORD dwFlags;                             <span class="hljs-comment">// unused</span>
  TCHAR szExeFile[MAX_PATH];     <span class="hljs-comment">// Path</span>
} PROCESSENTRY32;
</code></pre>
<h4 id="wts-functions">WTS Functions</h4>
<p>Windows Terminal Services (WTS) functions: WTSEnumerateProcesses and WTSEnumerateProcessesEx.</p>
<p>The function can enumerate processes on other machines</p>
<blockquote>
<p>WTS : a terminal services (also called Remote Desktop Services) environment &#x3002; &#x4E0E;Windows &#x8FDC;&#x7A0B;&#x8C03;&#x7528;&#x6709;&#x5173;&#x3002;</p>
</blockquote>
<h5 id="wtsenumerateprocesses">WTSEnumerateProcesses</h5>
<p><code>#include &lt;wtsapi32.h&gt;</code> <code>wtsapi32.lib</code></p>
<pre><code class="lang-c++"><span class="hljs-function">BOOL <span class="hljs-title">WTSEnumerateProcesses</span><span class="hljs-params">(
    _In_ HANDLE hServer, <span class="hljs-comment">// server&#x7684;&#x53E5;&#x67C4;</span>
  <span class="hljs-comment">// WTSOpenServer &#x83B7;&#x5F97;&#x8FDC;&#x7A0B;server&#x53E5;&#x67C4;</span>
  <span class="hljs-comment">// WTS_CURRENT_SERVER_HANDLE &#x83B7;&#x5F97;&#x672C;&#x5730;&#x673A;&#x5668;&#x53E5;&#x67C4;</span>
  _In_ DWORD Reserved, 
  _In_ DWORD Version, <span class="hljs-comment">// 1 -&gt; &#x51FD;&#x6570;&#x81EA;&#x52A8;&#x5206;&#x914D;&#x548C;free&#x5185;&#x5B58;</span>
  _Out_ PWTS_PROCESS_INFO *ppProcessInfo, 
     <span class="hljs-comment">// an array of structures of type WTS_PROCESS_INFO</span>
  <span class="hljs-comment">// &#x4F7F;&#x7528;WTSFreeMemory&#x91CA;&#x653E;&#x5185;&#x5B58;</span>
  _Out_ DWORD *pCount <span class="hljs-comment">// number of processes in the returned array</span>
)</span></span>;

<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> _WTS_PROCESS_INFO { 
  DWORD SessionId; 
  DWORD ProcessId; 
  LPTSTR pProcessName; 
  PSID pUserSid;  <span class="hljs-comment">// SID</span>
} WTS_PROCESS_INFO, *PWTS_PROCESS_INFO;
</code></pre>
<p>demo&#xFF1A;</p>
<pre><code class="lang-c++"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;wtsapi32.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">pragma</span> comment(lib, <span class="hljs-string">&quot;wtsapi32&quot;</span>) <span class="hljs-comment">// link</span></span>

<span class="hljs-function">CString <span class="hljs-title">GetUserNameFromSid</span><span class="hljs-params">(PSID sid)</span> </span>{
    <span class="hljs-keyword">if</span> (sid == <span class="hljs-literal">nullptr</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-string">L&quot;&quot;</span>;
    WCHAR name[<span class="hljs-number">128</span>], domain[<span class="hljs-number">64</span>];
    DWORD len = _countof(name);
    DWORD domainLen = _countof(domain);
    SID_NAME_USE use;
    <span class="hljs-keyword">if</span> (!::LookupAccountSid(<span class="hljs-literal">nullptr</span>, sid, name, &amp;len, domain, &amp;domainLen, &amp;use))
        <span class="hljs-keyword">return</span> <span class="hljs-string">L&quot;&quot;</span>;
    <span class="hljs-keyword">return</span> CString(domain) + <span class="hljs-string">L&quot;\\&quot;</span> + name;
}

<span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">EnumerateProcesses1</span><span class="hljs-params">()</span> </span>{
    PWTS_PROCESS_INFO info;
    DWORD count;
    <span class="hljs-comment">// &#x83B7;&#x5F97;&#x672C;&#x5730;&#x8FDB;&#x7A0B;&#x4FE1;&#x606F;</span>
    <span class="hljs-keyword">if</span> (!::WTSEnumerateProcesses(WTS_CURRENT_SERVER_HANDLE, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, &amp;info, &amp;count))
        <span class="hljs-comment">// &#x8FD4;&#x56DE;info</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">for</span> (DWORD i = <span class="hljs-number">0</span>; i &lt; count; i++) {
        <span class="hljs-keyword">auto</span> pi = info + i;
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\nPID: %5d (S: %d) (User: %ws) %ws&quot;</span>,
            pi-&gt;ProcessId, pi-&gt;SessionId,
            (PCWSTR)GetUserNameFromSid(pi-&gt;pUserSid), pi-&gt;pProcessName);
    }
    <span class="hljs-comment">// free</span>
    ::WTSFreeMemory(info);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<h5 id="wtsenumerateprocessesex">WTSEnumerateProcessesEx</h5>
<p>WTSEnumerateProcesses&#x7684;&#x6269;&#x5C55;</p>
<pre><code class="lang-c++"><span class="hljs-function">BOOL <span class="hljs-title">WTSEnumerateProcessesEx</span><span class="hljs-params">(
    _In_    HANDLE hServer, 
    _Inout_ DWORD * pLevel, <span class="hljs-comment">// 0&#x3001;1</span>
    _In_    DWORD SessionID,
    _Out_    PTSTR* pProcessInfo, <span class="hljs-comment">// return _WTS_PROCESS_INFO_EX or _WTS_PROCESS_INFO</span>
    _Out_    DWORD * pCount)</span></span>;  <span class="hljs-comment">// count</span>

<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> _WTS_PROCESS_INFO_EX {
    DWORD    SessionId;
    DWORD    ProcessId;
    LPTSTR    pProcessName;
    PSID    pUserSid;
    DWORD    NumberOfThreads;
    DWORD    HandleCount;
    DWORD    PagefileUsage; <span class="hljs-comment">// &#x56DB;&#x5B57;&#x8282;&#xFF0C;&#x53EF;&#x80FD;&#x4F1A;&#x51FA;&#x95EE;&#x9898;</span>
    DWORD    PeakPagefileUsage;
    DWORD    WorkingSetSize;
    DWORD    PeakWorkingSetSize;
    LARGE_INTEGER UserTime;
    LARGE_INTEGER KernelTime;
} WTS_PROCESS_INFO_EX, * PWTS_PROCESS_INFO_EX;
</code></pre>
<p>demo:</p>
<pre><code class="lang-c++"><span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">EnumerateProcesses2</span><span class="hljs-params">()</span> </span>{
    PWTS_PROCESS_INFO_EX info;
    DWORD count;
    DWORD level = <span class="hljs-number">1</span>; <span class="hljs-comment">// extended info</span>
    <span class="hljs-keyword">if</span> (!::WTSEnumerateProcessesEx(WTS_CURRENT_SERVER_HANDLE, &amp;level,
        WTS_ANY_SESSION, (PWSTR*)&amp;info, &amp;count))
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">for</span> (DWORD i = <span class="hljs-number">0</span>; i &lt; count; i++) {
        <span class="hljs-keyword">auto</span> pi = info + i;
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\nPID: %5d (S: %d) (T: %3d) (H: %4d) (CPU: %ws) (U: %ws) %ws&quot;</span>,
            pi-&gt;ProcessId, pi-&gt;SessionId, pi-&gt;NumberOfThreads, pi-&gt;HandleCount,
            (PCWSTR)GetCpuTime(pi),
            (PCWSTR)GetUserNameFromSid(pi-&gt;pUserSid), pi-&gt;pProcessName);
    }
    <span class="hljs-comment">// free</span>
    ::WTSFreeMemoryEx(WTSTypeProcessInfoLevel1, info, count);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}

<span class="hljs-function">CString <span class="hljs-title">GetCpuTime</span><span class="hljs-params">(PWTS_PROCESS_INFO_EX pi)</span> </span>{
    <span class="hljs-keyword">auto</span> totalTime = pi-&gt;KernelTime.QuadPart + pi-&gt;UserTime.QuadPart;
    <span class="hljs-keyword">return</span> CTimeSpan(totalTime / <span class="hljs-number">10000000L</span>L).Format(<span class="hljs-string">L&quot;%D:%H:%M:%S&quot;</span>);
}
</code></pre>
<h4 id="native-api">Native API</h4>
<p>using the native API exposed by NtDll.dll</p>
<blockquote>
<p>&#x5185;&#x6838;&#x51FD;&#x6570;&#x4E00;&#x822C;&#x65E0;&#x539F;&#x578B;&#xFF0C;&#x4F46;&#x56E0;&#x4E00;&#x4E9B;&#x5185;&#x6838;api&#x548C;&#x672C;&#x5730;api&#x5171;&#x4EAB;&#x4E00;&#x4E2A;&#x539F;&#x578B;&#x6240;&#x4EE5;&#x6709;&#x4E9B;api&#x539F;&#x578B;&#x53EF;&#x4EE5;&#x4ECE;Windows Driver Kit (WDK)&#x7684;&#x6587;&#x6863;&#x4E2D;&#x627E;&#x5230;&#x3002;</p>
</blockquote>
<p>&#x4F7F;&#x7528;native api: <code>#include &lt;winternl.h&gt;</code></p>
<p>&#x4F7F;&#x7528;NtQuerySystemInformation&#x53EF;&#x7528;&#x679A;&#x4E3E;&#x4FE1;&#x606F;&#x3002;</p>
<pre><code class="lang-c++"><span class="hljs-function">NTSTATUS WINAPI <span class="hljs-title">NtQuerySystemInformation</span><span class="hljs-params">(
    _In_      SYSTEM_INFORMATION_CLASS SystemInformationClass,
    _Inout_   PVOID                    SystemInformation,
    _In_      ULONG                    SystemInformationLength,
    _Out_opt_ PULONG                   ReturnLength
    )</span></span>;
</code></pre>
<p>&#x901A;&#x8FC7;&#x8BBE;&#x7F6E;SystemInformationClass&#x7ED3;&#x6784;&#x53EF;&#x4EE5;&#x679A;&#x4E3E;&#x4E0D;&#x540C;&#x7684;&#x4FE1;&#x606F;&#x3002;</p>
<pre><code class="lang-c++"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">enum</span> _SYSTEM_INFORMATION_CLASS { 
    SystemBasicInformation = <span class="hljs-number">0</span>, 
    SystemPerformanceInformation = <span class="hljs-number">2</span>, 
    SystemTimeOfDayInformation = <span class="hljs-number">3</span>, 
    SystemProcessInformation = <span class="hljs-number">5</span>,          <span class="hljs-comment">// SystemProcessInformation</span>
    <span class="hljs-comment">// Task Manager and Process Explorer use this to get process information.</span>
    SystemProcessorPerformanceInformation = <span class="hljs-number">8</span>, 
    SystemInterruptInformation = <span class="hljs-number">23</span>, 
    SystemExceptionInformation = <span class="hljs-number">33</span>, 
    SystemRegistryQuotaInformation = <span class="hljs-number">37</span>, 
    SystemLookasideInformation = <span class="hljs-number">45</span>, 
    SystemCodeIntegrityInformation = <span class="hljs-number">103</span>, 
    SystemPolicyInformation = <span class="hljs-number">134</span>, 
} SYSTEM_INFORMATION_CLASS;
</code></pre>
<p>&#x5982;&#x8BBE;&#x7F6E;&#x4E3A;SystemProcessInformation&#x5C31;&#x53EF;&#x4EE5;&#x679A;&#x4E3E;&#x8FDB;&#x7A0B;&#x4FE1;&#x606F;&#x3002;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;_SYSTEM_PROCESS_INFORMATION&#x7ED3;&#x6784;&#x4F53;&#x3002;_SYSTEM_PROCESS_INFORMATION&#x7ED3;&#x6784;&#x4F53;&#x5B8C;&#x6574;&#x4FE1;&#x606F;&#xFF1A;<a href="https://github.com/processhacker/phnt/blob/54730ea8b39f61bf088f83273fc2366d7235785b/ntexapi.h#L1621" target="_blank">https://github.com/processhacker/phnt/blob/54730ea8b39f61bf088f83273fc2366d7235785b/ntexapi.h#L1621</a> </p>
<blockquote>
<p>windowsNativeAPI&#x7684;&#x6709;&#x4E9B;&#x7ED3;&#x6784;&#x662F;&#x95ED;&#x6E90;&#x7684;&#xFF0C;&#x53EA;&#x80FD;&#x901A;&#x8FC7;&#x9006;&#x5411;&#x7B49;&#x65B9;&#x6CD5;&#x83B7;&#x5F97;&#x539F;&#x578B;&#x3002;</p>
<p>&#x53EF;&#x7528;&#x4F7F;&#x7528;&#x5F00;&#x6E90;&#x9879;&#x76EE;&#x83B7;&#x5F97;&#x76F8;&#x5173;api&#x4FE1;&#x606F;:</p>
<p>processhacker: <a href="https://github.com/processhacker" target="_blank">https://github.com/processhacker</a> </p>
<p>phnt : <a href="https://github.com/processhacker/phnt" target="_blank">https://github.com/processhacker/phnt</a> // contains the largest definitions of native APIs, structures, enumerations and definitions</p>
<p>Exercises : &#x7B80;&#x5355;&#x7684;&#x8FDB;&#x7A0B;&#x7BA1;&#x7406;&#x5DE5;&#x5177;&#x3002;</p>
</blockquote>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="../02/" class="navigation navigation-prev " aria-label="Previous page: Chapter 2: Objects and Handles">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="../04/" class="navigation navigation-next " aria-label="Next page: Chapter 4: Jobs">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Chapter 3: Processes","level":"1.4","depth":1,"next":{"title":"Chapter 4: Jobs","level":"1.5","depth":1,"path":"04/README.md","ref":"04/README.md","articles":[]},"previous":{"title":"Chapter 2: Objects and Handles","level":"1.3","depth":1,"path":"02/README.md","ref":"02/README.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":[],"pluginsConfig":{"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"03/README.md","mtime":"2021-10-10T14:31:04.548Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2021-10-10T14:57:01.707Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

